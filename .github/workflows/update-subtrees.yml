name: Nightly subtree update

on:
  schedule:
    - cron: '0 4 * * *'   # ~5:00 Europe/Rome in winter
  workflow_dispatch:       # optional manual trigger

jobs:
  update-subtrees:
    runs-on: ubuntu-latest

    permissions:
      contents: write      # needed to push back to the repo

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.AMB_SUBTREE_UPDATE_TOKEN }}
          fetch-depth: 0  # Get full history for subtree to work

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Ensure subtree remotes exist
        run: |
          # aggiornamenti-nomenclatura
          git remote add aggiornamenti-IF-remote https://github.com/ambvilladogna/Aggiornamenti-Index-Fungorum.git || true
          # biblioteca
          git remote add biblioteca-remote https://github.com/ambvilladogna/biblioteca.git || true
          # fungi-census
          git remote add fungi-census-remote https://github.com/ambvilladogna/fungi-census.git || true

      - name: Fetch subtree remotes
        run: |
          git fetch aggiornamenti-IF-remote
          git fetch biblioteca-remote
          git fetch fungi-census-remote

      - name: Pull subtree updates
        run: |
          git subtree pull --prefix=aggiornamenti-nomenclatura aggiornamenti-IF-remote main --squash -m "Update aggiornamenti-nomenclatura subtree"
          git subtree pull --prefix=biblioteca biblioteca-remote main --squash -m "Update biblioteca subtree"
          git subtree pull --prefix=fungi-census fungi-census-remote master --squash -m "Update fungi-census subtree"

      - name: Push changes
        run: |
          # Only push if the local branch is ahead of origin
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git push origin HEAD